class DemoController < ApplicationController
    def home
    
    end
    def mail
      email_list = params[:email_id].split(",")
      for email in email_list
          url = "https://sendgrid.com/api/mail.send.json"

          response = HTTParty.post url, :body => {
            "api_user" => "stranger9811",
            "api_key" => "password",
            "to" => email,
            "from" => cookies[:user_email],
            "subject" => "Test Mail",
            "text" => "You are invited to party."
          }
      end
    
    end
    
    def main
      require 'google/api_client'
      itunes_limit=2
      artist_limit=5
      @graph=Koala::Facebook::API.new(cookies[:access_token])
      
      developer_key = "AIzaSyBLkCKyf8cM6Hzxe3r19kmmR0gh7MTidH4"
      api_service = "youtube"
      api_version = "v3"

      client = Google::APIClient.new(:key => developer_key,
                                     :authorization => nil)
      youtube = client.discovered_api(api_service, api_version)
      @friend = []
      @aa = []
      @id_list=[]
      for i in params
        x=i[0].split(" ")
        if x[0]=="user_comming"
          @id_list.push(x[1])
        end
      end
      @music_to_id=Hash.new()
      @music_list=Hash.new()
      @profile_pic_list=Hash.new()
      @username_list=Hash.new()
      for id in @id_list  
        data=@graph.get_object(id+"?fields=music,picture,username")  
        music_data = data["music"]
            
        songs=[]
            
        if music_data
           music_names = music_data["data"]
                
           for current_song in music_names
             songs.push(current_song["name"])
             if @music_to_id[current_song["name"]]
               @music_to_id[current_song["name"]].push(id)
             else
              
               @music_to_id[current_song["name"]]=[]
               @music_to_id[current_song["name"]].push(id)
             end
           end
         
         end
         @music_list[id]=songs
         @profile_pic_list[id] = data["picture"]["data"]["url"]
         @username_list[id]=data["username"]
        
      end
      
      @top_song_list=Hash.new(0)
      for id in @id_list
        for song in @music_list[id]                         #add only invited friends
          @top_song_list[song]+=1
        end
      end

      @top_song_list =  @top_song_list.sort_by {|a,b| b}
      @top_song_list = @top_song_list.reverse
      @songs=[]
      i=0
      for album in @top_song_list
        @songs.push(album[0])
        i+=1
        if i>=artist_limit
          break
        end
      end
      
      @top_song_list=@songs
      @music_database=[]
      itunes = ITunes::Client.new
      
      for song_single in @top_song_list
        
        song_list = itunes.music(song_single, :limit => itunes_limit)
        song_list=song_list.results
    
        for song_loop in song_list                   # don't take all songs
          
          music=Hash.new()
          music["title"] = song_loop.track_name
          music["itunes_track_id"]   =song_loop.track_id
          music["artist"]  = song_single
          if song_loop.collection_name
            music["album"] = song_loop.collection_name
          else
            music["album"] = ""
          end
           
          opts = Trollop::options do
            opt :q, 'Search term', :type => String, :default => "#{music["title"]}  #{music["album"]} #{music["artist"]}"
            opt :maxResults, 'Max results', :type => :int, :default => 1
          end



          opts[:part] = 'id,snippet'
          search_response = client.execute!(
            :api_method => youtube.search.list,
            :parameters => opts
          )

          video_id=""

          search_response.data.items.each do |search_result|
            case search_result.id.kind
              when 'youtube#video'
                video_id=search_result.id.videoId
   
            end
          end
          if video_id!=""
            music["youtube_id"] = video_id
            @music_database.push(music)
          end
        end
      end
      for i in @music_database 
        s = Song.new 
        s.party_id = $party.id
        s.itunes_track_id = i["itunes_track_id"] 
        s.artist = i["artist"]
        s.votes = 0
        s.title = i["title"]
        s.youtube_id = i["youtube_id"]
        s.album=i["album"]
        s.save
      end

      redirect_to :controller => 'song' , :action => 'list' , :party_id=>$party.id
      
    end
    def index
        #access_token_hash = MiniFB.oauth_access_token('199535680199935', "http://protected-hollows-6010.herokuapp.com/demo/index",  '9924d075c17752a89d0e19a0b9439ea9', params[:code])
        #@access_token = access_token_hash["access_token"]
        @access_token = "CAACEdEose0cBAPZAiRZCLDgnLUXFEh7nsurilScvxj0eTnMjSO7JXxQKiAOSRXcjGSsZAhIByPRyUBJC4BS5W8phdwrfHZBgXq3bPOt9hVsxLZC1Qngv692XGhfYTViPPUpDiIUPjTakAMRbivfFioJK6UlZBALvgZD"
        @graph=Koala::Facebook::API.new(@access_token)
        cookies[:access_token]=@access_token
        @user=@graph.get_object("me")
        $party=Party.create(:party_admin=>@user["name"])
        cookies[:party_id]=$party.id
        cookies[:user_email] = @user["username"]+"@sendgrid.me"
        @friends = @graph.get_connections(@user["id"],"friends")
        @name_list=Hash.new
        @id_list=[]
        for friend in @friends
            @id_list.push(friend["id"])
            @name_list[friend["id"]]=friend["name"]
        end
      
        
        profile_pic = @graph.get_object("me/friends?fields=picture")
        @profile_pic_list=Hash.new()

        for friend in profile_pic
          @profile_pic_list[friend["id"]]=friend["picture"]["data"]["url"]
        
        end
       
    end
end
